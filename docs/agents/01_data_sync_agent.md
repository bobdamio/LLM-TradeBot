# ğŸ•µï¸ DataSyncAgent (The Oracle)

> æ•°æ®å…ˆçŸ¥ - å¼‚æ­¥æ•°æ®é‡‡é›†ä¸åŒè§†å›¾æ„å»º

## æ¦‚è¿°

DataSyncAgent æ˜¯å¤š Agent æ¡†æ¶çš„æ•°æ®å…¥å£ï¼Œè´Ÿè´£ä» Binance å’Œå¤–éƒ¨é‡åŒ– API å¼‚æ­¥è·å–å¸‚åœºæ•°æ®ï¼Œæ„å»ºåŒè§†å›¾ï¼ˆStable + Liveï¼‰æ•°æ®ç»“æ„ä¾›ä¸‹æ¸¸ Agent ä½¿ç”¨ã€‚

## æ ¸å¿ƒèŒè´£

1. **å¼‚æ­¥å¹¶å‘è¯·æ±‚** - ä½¿ç”¨ `asyncio.gather` åŒæ—¶è·å–å¤šå‘¨æœŸ K çº¿æ•°æ®
2. **åŒè§†å›¾æ•°æ®ç»“æ„** - åˆ†ç¦»å·²å®Œæˆ K çº¿ (stable) å’Œå½“å‰æœªå®Œæˆ K çº¿ (live)
3. **æ—¶é—´å¯¹é½éªŒè¯** - ç¡®ä¿å¤šå‘¨æœŸæ•°æ®çš„æ—¶é—´ä¸€è‡´æ€§
4. **å¤–éƒ¨æ•°æ®é›†æˆ** - è·å–æœºæ„èµ„é‡‘æµã€OI ç­‰é‡åŒ–æŒ‡æ ‡

## æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DataSyncAgent                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥ï¼š                                                           â”‚
â”‚   - symbol: äº¤æ˜“å¯¹ (å¦‚ BTCUSDT)                                  â”‚
â”‚   - limit: K çº¿æ•°é‡ (é»˜è®¤ 300)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¹¶å‘è¯·æ±‚ï¼š                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚ 5m K-lines â”‚  â”‚15m K-lines â”‚  â”‚ 1h K-lines â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚ Quant API  â”‚  â”‚Funding Rateâ”‚  â”‚    OI      â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å‡ºï¼šMarketSnapshot                                             â”‚
â”‚   - stable_5m/15m/1h: å·²å®Œæˆ K çº¿ DataFrame                      â”‚
â”‚   - live_5m/15m/1h: å½“å‰ K çº¿ Dict                               â”‚
â”‚   - quant_data: å¤–éƒ¨é‡åŒ–æ•°æ®                                     â”‚
â”‚   - binance_funding: èµ„é‡‘è´¹ç‡                                    â”‚
â”‚   - binance_oi: æŒä»“é‡                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®æ•°æ®ç»“æ„

### MarketSnapshot

```python
@dataclass
class MarketSnapshot:
    # 5m æ•°æ®
    stable_5m: pd.DataFrame  # å·²å®Œæˆ K çº¿ (iloc[:-1])
    live_5m: Dict            # å½“å‰ K çº¿ (iloc[-1])
    
    # 15m æ•°æ®
    stable_15m: pd.DataFrame
    live_15m: Dict
    
    # 1h æ•°æ®
    stable_1h: pd.DataFrame
    live_1h: Dict
    
    # å…ƒæ•°æ®
    timestamp: datetime
    alignment_ok: bool       # æ—¶é—´å¯¹é½çŠ¶æ€
    fetch_duration: float    # è·å–è€—æ—¶ï¼ˆç§’ï¼‰
    
    # é‡åŒ–æ•°æ®
    quant_data: Dict
    binance_funding: Dict
    binance_oi: Dict
```

## æ ¸å¿ƒæ–¹æ³•

### `fetch_all_timeframes(symbol, limit)`

å¼‚æ­¥å¹¶å‘è·å–æ‰€æœ‰å‘¨æœŸæ•°æ®ã€‚

**ä¼˜åŒ–ç‚¹**ï¼š

- ä½¿ç”¨ `asyncio.gather` å¹¶å‘è¯·æ±‚ï¼ŒèŠ‚çœçº¦ 60% IO æ—¶é—´
- æ—¶é—´å¯¹é½éªŒè¯å®¹å·®ï¼š15m æ•°æ®å…è®¸ 15 åˆ†é’Ÿå·®å¼‚ï¼Œ1h æ•°æ®å…è®¸ 1 å°æ—¶å·®å¼‚

### `_to_dataframe(klines)`

å°†åŸå§‹ K çº¿æ•°æ®è½¬æ¢ä¸º Pandas DataFrameï¼ŒåŒ…å«ï¼š

- æ—¶é—´æˆ³è½¬æ¢ä¸º datetime ç´¢å¼•
- æ•°å€¼åˆ—ç±»å‹è½¬æ¢

### `_check_alignment(k5m, k15m, k1h)`

æ£€æŸ¥å¤šå‘¨æœŸæ•°æ®çš„æ—¶é—´å¯¹é½æ€§ï¼š

- 5m vs 15m: å…è®¸ 15 åˆ†é’Ÿå·®å¼‚
- 5m vs 1h: å…è®¸ 1 å°æ—¶å·®å¼‚

## ä¾èµ–å…³ç³»

```
DataSyncAgent
â”œâ”€â”€ BinanceClient (src/api/binance_client.py)
â”œâ”€â”€ QuantClient (src/api/quant_client.py)
â””â”€â”€ OITracker (src/utils/oi_tracker.py)
```

## é…ç½®

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| symbol | BTCUSDT | äº¤æ˜“å¯¹ |
| limit | 300 | è·å– K çº¿æ•°é‡ |

## ä½¿ç”¨ç¤ºä¾‹

```python
from src.agents.data_sync_agent import DataSyncAgent

agent = DataSyncAgent()
snapshot = await agent.fetch_all_timeframes("BTCUSDT", limit=300)

# è·å–å®æ—¶ä»·æ ¼
live_price = agent.get_live_price("5m")

# è·å–ç¨³å®š DataFrame
df_5m = agent.get_stable_dataframe("5m")
```

## æ—¥å¿—è¾“å‡º

Dashboard æ—¥å¿—æ ¼å¼ï¼š

```
ğŸ•µï¸ DataSyncAgent (The Oracle): Action=Fetch[5m,15m,1h] | Snapshot=$96000.00
```
