# ğŸ›¡ï¸ RiskAuditAgent (The Guardian)

> é£æ§å®ˆæŠ¤è€… - äº¤æ˜“å†³ç­–çš„æœ€ç»ˆå®¡è®¡é˜²çº¿

## æ¦‚è¿°

RiskAuditAgent æ˜¯å¤š Agent æ¡†æ¶çš„æœ€ç»ˆå®‰å…¨é˜²çº¿ï¼Œæ‹¥æœ‰å¯¹æ‰€æœ‰äº¤æ˜“å†³ç­–çš„ä¸€ç¥¨å¦å†³æƒï¼Œè´Ÿè´£æ­¢æŸæ–¹å‘ä¿®æ­£ã€èµ„é‡‘é¢„æ¼”ã€æ æ†æ£€æŸ¥ç­‰æ ¸å¿ƒé£æ§åŠŸèƒ½ã€‚

## æ ¸å¿ƒèŒè´£

1. **æ­¢æŸæ–¹å‘ä¿®æ­£** - è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®æ­£æ­¢æŸæ–¹å‘é”™è¯¯
2. **èµ„é‡‘é¢„æ¼”** - æ¨¡æ‹Ÿè®¢å•æ‰§è¡Œï¼ŒéªŒè¯ä¿è¯é‡‘å……è¶³
3. **ä¸€ç¥¨å¦å†³** - é«˜é£é™©å†³ç­–ç›´æ¥æ‹¦æˆª
4. **ç‰©ç†éš”ç¦»** - ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»– Agent çŠ¶æ€
5. **å®¡è®¡æ—¥å¿—** - è®°å½•æ‰€æœ‰æ‹¦æˆªäº‹ä»¶å’Œä¿®æ­£

## æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       RiskAuditAgent                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥ï¼š                                                           â”‚
â”‚   - decision: DecisionCoreAgent è¾“å‡º (å« action, entry, SL/TP)   â”‚
â”‚   - current_position: å½“å‰æŒä»“ä¿¡æ¯                               â”‚
â”‚   - account_balance: è´¦æˆ·å¯ç”¨ä½™é¢                                â”‚
â”‚   - current_price: å½“å‰å¸‚åœºä»·æ ¼                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 0. å¿«é€Ÿè¿‡æ»¤                                               â”‚   â”‚
â”‚  â”‚   â€¢ hold â†’ ç›´æ¥é€šè¿‡                                       â”‚   â”‚
â”‚  â”‚   â€¢ å¸‚åœºçŠ¶æ€æ£€æŸ¥ (unknown/volatile â†’ æ‹¦æˆª)                 â”‚   â”‚
â”‚  â”‚   â€¢ ä»·æ ¼ä½ç½®æ£€æŸ¥ (ä¸­éƒ¨åŒºé—´ â†’ æ‹¦æˆª)                         â”‚   â”‚
â”‚  â”‚   â€¢ ç›ˆäºæ¯”æ£€æŸ¥ (R/R < 1.5 â†’ æ‹¦æˆª)                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. ä¸€ç¥¨å¦å†³æ£€æŸ¥                                           â”‚   â”‚
â”‚  â”‚   â€¢ é€†å‘å¼€ä»“æ£€æŸ¥ (æŒä»“æ—¶åå‘å¼€ä»“ â†’ æ‹¦æˆª)                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 2. æ­¢æŸæ–¹å‘æ£€æŸ¥ä¸ä¿®æ­£                                      â”‚   â”‚
â”‚  â”‚   â€¢ åšå¤š: æ­¢æŸå¿…é¡» < å…¥åœºä»·                                â”‚   â”‚
â”‚  â”‚   â€¢ åšç©º: æ­¢æŸå¿…é¡» > å…¥åœºä»·                                â”‚   â”‚
â”‚  â”‚   â€¢ è‡ªåŠ¨ä¿®æ­£ä¸ºå…¥åœºä»· Â±2%                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 3-6. èµ„é‡‘ä¸é£é™©æ£€æŸ¥                                        â”‚   â”‚
â”‚  â”‚   â€¢ ä¿è¯é‡‘å……è¶³æ€§                                           â”‚   â”‚
â”‚  â”‚   â€¢ æ æ†é™åˆ¶                                               â”‚   â”‚
â”‚  â”‚   â€¢ ä»“ä½å æ¯”                                               â”‚   â”‚
â”‚  â”‚   â€¢ æ€»é£é™©æ•å£                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å‡ºï¼šRiskCheckResult                                            â”‚
â”‚   - passed: bool                                                â”‚
â”‚   - risk_level: SAFE / WARNING / DANGER / FATAL                 â”‚
â”‚   - blocked_reason: æ‹¦æˆªåŸå›  (å¦‚æœªé€šè¿‡)                          â”‚
â”‚   - corrections: è‡ªåŠ¨ä¿®æ­£å†…å®¹                                    â”‚
â”‚   - warnings: è­¦å‘Šåˆ—è¡¨                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é£é™©ç­‰çº§

```python
class RiskLevel(Enum):
    SAFE = "safe"       # å®‰å…¨ï¼Œå¯æ‰§è¡Œ
    WARNING = "warning" # è­¦å‘Šï¼Œå¯æ‰§è¡Œä½†éœ€å…³æ³¨
    DANGER = "danger"   # å±é™©ï¼Œå»ºè®®äººå·¥ç¡®è®¤
    FATAL = "fatal"     # è‡´å‘½ï¼Œå·²æ‹¦æˆª
```

## å…³é”®æ•°æ®ç»“æ„

### RiskCheckResult

```python
@dataclass
class RiskCheckResult:
    passed: bool                     # æ˜¯å¦é€šè¿‡
    risk_level: RiskLevel            # é£é™©ç­‰çº§
    blocked_reason: Optional[str]    # æ‹¦æˆªåŸå› 
    corrections: Optional[Dict]      # è‡ªåŠ¨ä¿®æ­£å†…å®¹
    warnings: List[str]              # è­¦å‘Šä¿¡æ¯
```

### PositionInfo

```python
@dataclass
class PositionInfo:
    symbol: str           # äº¤æ˜“å¯¹
    side: str             # 'long' æˆ– 'short'
    entry_price: float    # å…¥åœºä»·æ ¼
    quantity: float       # æŒä»“æ•°é‡
    unrealized_pnl: float # æœªå®ç°ç›ˆäº
```

## é£æ§è§„åˆ™è¯¦è§£

### 1. å¸‚åœºçŠ¶æ€æ‹¦æˆª

| çŠ¶æ€ | å¤„ç† | åŸå›  |
|------|------|------|
| unknown | æ‹¦æˆª | å¸‚åœºçŠ¶æ€ä¸æ˜ç¡® |
| volatile | æ‹¦æˆª | é«˜æ³¢åŠ¨é£é™© |
| choppy + ä½ä¿¡å¿ƒ | æ‹¦æˆª | éœ‡è¡å¸‚ä¿¡å¿ƒä¸è¶³ |

### 2. ä»·æ ¼ä½ç½®æ‹¦æˆª

| ä½ç½® | åšå¤š | åšç©º |
|------|------|------|
| 0-30% | âœ… å…è®¸ | âŒ æ‹¦æˆª (åå¼¹é£é™©) |
| 30-70% | âŒ æ‹¦æˆª (R/R å·®) | âŒ æ‹¦æˆª (R/R å·®) |
| 70-100% | âŒ æ‹¦æˆª (å›è°ƒé£é™©) | âœ… å…è®¸ |

### 3. ç›ˆäºæ¯”æ£€æŸ¥

```python
risk = abs(entry_price - stop_loss)
reward = abs(take_profit - entry_price)
rr_ratio = reward / risk

if rr_ratio < 1.5:
    return BLOCK("é£é™©å›æŠ¥æ¯”ä¸è¶³")
```

### 4. æ­¢æŸæ–¹å‘ä¿®æ­£

```python
# åšå¤š
if action == 'long' and stop_loss >= entry_price:
    corrected = entry_price * 0.98  # è‡ªåŠ¨ä¿®æ­£ä¸º -2%

# åšç©º
if action == 'short' and stop_loss <= entry_price:
    corrected = entry_price * 1.02  # è‡ªåŠ¨ä¿®æ­£ä¸º +2%
```

### 5. æ­¢æŸè·ç¦»é™åˆ¶

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| min_stop_loss_pct | 0.5% | é˜²æ­¢ç§’çˆ† |
| max_stop_loss_pct | 5.0% | é˜²æ­¢è¿‡åº¦äºæŸ |

### 6. èµ„é‡‘æ£€æŸ¥

```python
required_margin = (quantity * entry_price) / leverage
if required_margin > account_balance * 0.95:
    return BLOCK("ä¿è¯é‡‘ä¸è¶³")
```

## é…ç½®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| max_leverage | 10.0 | æœ€å¤§æ æ†å€æ•° |
| max_position_pct | 0.3 | å•ä»“ä½æœ€å¤§å æ¯” (30%) |
| max_total_risk_pct | 0.02 | æœ€å¤§é£é™©æ•å£ (2%) |
| min_stop_loss_pct | 0.005 | æœ€å°æ­¢æŸè·ç¦» (0.5%) |
| max_stop_loss_pct | 0.05 | æœ€å¤§æ­¢æŸè·ç¦» (5%) |

## å®¡è®¡ç»Ÿè®¡

```python
block_stats = {
    'total_checks': 0,
    'total_blocks': 0,
    'stop_loss_corrections': 0,
    'reverse_position_blocks': 0,
    'insufficient_margin_blocks': 0,
    'over_leverage_blocks': 0,
}
```

## ä¾èµ–å…³ç³»

```
RiskAuditAgent
â”œâ”€â”€ RiskLevel (é£é™©ç­‰çº§æšä¸¾)
â”œâ”€â”€ RiskCheckResult (æ£€æŸ¥ç»“æœ)
â”œâ”€â”€ PositionInfo (æŒä»“ä¿¡æ¯)
â””â”€â”€ ç‹¬ç«‹è¿è¡Œï¼Œæ— å¤–éƒ¨ Agent ä¾èµ–
```

## ä½¿ç”¨ç¤ºä¾‹

```python
from src.agents.risk_audit_agent import RiskAuditAgent, PositionInfo

agent = RiskAuditAgent(
    max_leverage=10.0,
    max_position_pct=0.3
)

result = await agent.audit_decision(
    decision={
        'action': 'long',
        'entry_price': 96000.0,
        'stop_loss': 97000.0,  # é”™è¯¯ï¼åšå¤šæ­¢æŸ > å…¥åœºä»·
        'take_profit': 100000.0,
        'quantity': 0.01,
        'leverage': 5.0,
        'confidence': 75
    },
    current_position=None,
    account_balance=10000.0,
    current_price=96000.0
)

if result.passed:
    if result.corrections:
        print(f"å·²ä¿®æ­£: {result.corrections}")
    print(f"é£é™©ç­‰çº§: {result.risk_level.value}")
else:
    print(f"æ‹¦æˆª: {result.blocked_reason}")
```

## æ—¥å¿—è¾“å‡º

Dashboard æ—¥å¿—æ ¼å¼ï¼š

```
ğŸ›¡ï¸ RiskAuditAgent (The Guardian): Result: âœ… PASSED (Risk: warning) | âš ï¸ æ­¢æŸæ–¹å‘é”™è¯¯å·²ä¿®æ­£
```

æˆ–æ‹¦æˆªæ—¶ï¼š

```
ğŸ›¡ï¸ RiskAuditAgent (The Guardian): Result: âŒ BLOCKED (ä»·æ ¼å¤„äºåŒºé—´ä¸­éƒ¨(52.3%)ï¼ŒR/Ræå·®ï¼Œç¦æ­¢å¼€ä»“)
```
